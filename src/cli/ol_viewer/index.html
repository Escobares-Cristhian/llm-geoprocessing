<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Geoprocessing Viewer (OpenLayers)</title>

  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ol@v10.7.0/ol.css" />

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #container { display:grid; grid-template-columns:280px 1fr; height:100%; }
    #sidebar {
      padding:10px;
      border-right:1px solid #ccc;
      font-family:sans-serif;
      overflow:auto;
      box-sizing:border-box;
    }
    #map { width:100%; height:100%; background:#eef; }
    .title { font-weight:600; margin-bottom:6px; }
    .muted { color:#666; font-size:12px; margin-bottom:8px; }
    .layer-item { margin:6px 0; font-size:13px; }
  </style>
</head>
<body>
  <div id="container">
    <div id="sidebar">
      <div class="title">Layers</div>
      <div class="muted">Basemap is always on. Toggle products below.</div>
      <div id="layerList"></div>
    </div>
    <div id="map"></div>
  </div>

  <!-- OpenLayers full build -->
  <script src="https://cdn.jsdelivr.net/npm/ol@v10.7.0/dist/ol.js"></script>

  <script>
    // Simple WebGL availability check
    function hasWebGL() {
      try {
        var canvas = document.createElement('canvas');
        return !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
      } catch (e) {
        return false;
      }
    }
    var webglOk = hasWebGL();

    var baseLayer;
    if (webglOk) {
      baseLayer = new ol.layer.WebGLTile({
        source: new ol.source.XYZ({
          url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
          maxZoom: 19,
          crossOrigin: 'anonymous',
          attributions: 'Â© OpenStreetMap contributors'
        }),
        visible: true,
        transition: 0
      });
    } else {
      baseLayer = new ol.layer.Tile({
        source: new ol.source.OSM(),
        visible: true
      });
    }

    var map = new ol.Map({
      target: 'map',
      layers: [baseLayer],
      view: new ol.View({
        center: ol.proj.fromLonLat([0, 0]),
        zoom: 2
      })
    });

    function fixSizeSoon() {
      try { map.updateSize(); } catch (e) {}
    }
    window.addEventListener('load', fixSizeSoon);
    window.addEventListener('resize', fixSizeSoon);
    setTimeout(fixSizeSoon, 0);
    setTimeout(fixSizeSoon, 200);

    // Registry of product layers
    var rasterLayers = new Map(); // tifName -> ol.layer.Image

    function refreshLayers() {
      fetch('layers.json?ts=' + Date.now())
        .then(function (res) { return res.ok ? res.json() : []; })
        .then(function (data) {
          if (!Array.isArray(data)) data = [];
          var container = document.getElementById('layerList');

          // Desired set from JSON
          var desired = new Set();
          data.forEach(function (d) { desired.add(d.name); });

          // Remove layers no longer present
          Array.from(rasterLayers.entries()).forEach(function ([name, layer]) {
            if (!desired.has(name)) {
              map.removeLayer(layer);
              rasterLayers.delete(name);
            }
          });

          // Rebuild sidebar
          container.innerHTML = '';

          data.forEach(function (d) {
            var name = d.name;
            var title = d.title || name;
            var url = d.url;
            var visible = d.visible !== false;
            var extent = d.extent;
            var srcProj = d.projection || 'EPSG:3857';

            if (!extent || extent.length !== 4) {
              return; // skip if no extent
            }

            if (srcProj !== 'EPSG:3857') {
              extent = ol.proj.transformExtent(extent, srcProj, 'EPSG:3857');
            }

            var layer = rasterLayers.get(name);
            if (!layer) {
              layer = new ol.layer.Image({
                visible: visible,
                source: new ol.source.ImageStatic({
                  url: url,
                  imageExtent: extent,
                  projection: 'EPSG:3857'
                })
              });
              rasterLayers.set(name, layer);
              map.addLayer(layer);
            } else {
              layer.setVisible(visible);
            }

            // Sidebar checkbox
            var div = document.createElement('div');
            div.className = 'layer-item';

            var label = document.createElement('label');
            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = layer.getVisible();
            checkbox.addEventListener('change', function () {
              layer.setVisible(checkbox.checked);
            });

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(' ' + title));
            div.appendChild(label);
            container.appendChild(div);
          });
        })
        .catch(function (err) {
          console.error(err);
        });
    }

    refreshLayers();
    setInterval(refreshLayers, 2000);
  </script>
</body>
</html>
